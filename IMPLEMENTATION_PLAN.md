# å®Œæ•´å®ç°è®¡åˆ’ - åŠ¨æ€æŒ‰é’®å’Œä¼šè¯ç®¡ç†

## ğŸ¯ ç›®æ ‡

å®ç°ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ï¼š
1. **åŠ¨æ€æŒ‰é’®** - AI æ ¹æ®æƒ…å†µç”Ÿæˆæ™ºèƒ½å»ºè®®
2. **ä¼šè¯ä¸Šä¸‹æ–‡** - ä¿æŒä¼šè¯é”å®šï¼Œç®€åŒ–äº¤äº’
3. **æ™ºèƒ½é€‰æ‹©** - æœªæŒ‡å®šä¼šè¯æ—¶æ˜¾ç¤ºé€‰æ‹©æŒ‰é’®

---

## ğŸ“‹ æ–‡ä»¶ä¿®æ”¹æ¸…å•

### 1. `telegram_mcp_server/server.py`
- [ ] æ·»åŠ  `telegram_notify_with_actions` å·¥å…·
- [ ] ä¼˜åŒ– `telegram_notify` çš„æç¤ºè¯
- [ ] æ·»åŠ å¤„ç†å‡½æ•° `handle_telegram_notify_with_actions`

### 2. `telegram_mcp_server/bot.py`
- [ ] æ·»åŠ  `pending_messages` å­˜å‚¨
- [ ] æ·»åŠ  `pending_actions` å­˜å‚¨
- [ ] æ·»åŠ  `handle_message` å¤„ç†æ™®é€šæ¶ˆæ¯
- [ ] æ·»åŠ  `button_callback` å¤„ç†æŒ‰é’®ç‚¹å‡»
- [ ] æ·»åŠ  `/keep` å‘½ä»¤
- [ ] æ”¹è¿› `/to` å‘½ä»¤
- [ ] æ·»åŠ ä¼šè¯é€‰æ‹©æŒ‰é’®é€»è¾‘

### 3. `telegram_mcp_server/message_queue.py`
- æ— éœ€ä¿®æ”¹ï¼ˆå·²æœ‰åŠŸèƒ½è¶³å¤Ÿï¼‰

### 4. `telegram_mcp_server/session.py`
- æ— éœ€ä¿®æ”¹ï¼ˆå·²æœ‰åŠŸèƒ½è¶³å¤Ÿï¼‰

---

## ğŸ”§ å®ç°ç»†èŠ‚

### Phase 1: æ·»åŠ åŠ¨æ€æŒ‰é’®æ”¯æŒ

#### 1.1 åœ¨ server.py æ·»åŠ æ–°å·¥å…·

```python
Tool(
    name="telegram_notify_with_actions",
    description="""[è¯¦ç»†çš„æç¤ºè¯ - è§ BOT_IMPROVEMENTS.md]""",
    inputSchema={
        "type": "object",
        "properties": {
            "event": {...},
            "summary": {...},
            "details": {...},
            "actions": {
                "type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "text": {"type": "string"},
                        "action": {"type": "string"},
                        "emoji": {"type": "string"}
                    },
                    "required": ["text", "action"]
                },
                "maxItems": 4
            }
        },
        "required": ["event", "summary"]
    }
)
```

#### 1.2 æ·»åŠ å¤„ç†å‡½æ•°

```python
async def handle_telegram_notify_with_actions(session, arguments: dict):
    # 1. éªŒè¯å‚æ•°
    # 2. æ ¼å¼åŒ–æ¶ˆæ¯
    # 3. åˆ›å»ºæŒ‰é’®
    # 4. å­˜å‚¨ actions åˆ°ä¸´æ—¶å­˜å‚¨
    # 5. å‘é€åˆ° Telegram
    pass
```

### Phase 2: å®ç°ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†

#### 2.1 æ·»åŠ ç”¨æˆ·æ•°æ®å­˜å‚¨

```python
# åœ¨ bot.py é¡¶éƒ¨
user_contexts = {}  # {user_id: {"active_session": session_id}}
pending_messages = {}  # {user_id: message_text}
pending_actions = {}  # {action_id: action_command}
```

#### 2.2 æ·»åŠ  /keep å‘½ä»¤

```python
async def cmd_keep(update, context):
    # è®¾ç½®/å–æ¶ˆæ´»è·ƒä¼šè¯
    pass
```

#### 2.3 æ”¹è¿› /to å‘½ä»¤

```python
async def cmd_to(update, context):
    # å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œè®¾ç½®ä¸ºæ´»è·ƒä¼šè¯
    # å¦‚æœæœ‰æ¶ˆæ¯ï¼Œå‘é€å¹¶è®¾ç½®ä¸ºæ´»è·ƒä¼šè¯
    pass
```

### Phase 3: å®ç°æ™ºèƒ½ä¼šè¯é€‰æ‹©

#### 3.1 æ·»åŠ æ¶ˆæ¯å¤„ç†å™¨

```python
async def handle_message(update, context):
    # 1. æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒä¼šè¯
    # 2. å¦‚æœæœ‰ï¼Œç›´æ¥å‘é€
    # 3. å¦‚æœæ²¡æœ‰ï¼Œæ˜¾ç¤ºä¼šè¯é€‰æ‹©æŒ‰é’®
    pass
```

#### 3.2 æ·»åŠ æŒ‰é’®å›è°ƒ

```python
async def button_callback(update, context):
    # å¤„ç†ä¸‰ç§ç±»å‹çš„æŒ‰é’®ï¼š
    # 1. send_to:session_id - å‘é€æ¶ˆæ¯åˆ°ä¼šè¯
    # 2. execute:session_id:action_id - æ‰§è¡ŒåŠ¨ä½œ
    # 3. cancel - å–æ¶ˆæ“ä½œ
    pass
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### æµ‹è¯• 1: åŠ¨æ€æŒ‰é’®
- [ ] AI å‘é€å¸¦æŒ‰é’®çš„é€šçŸ¥
- [ ] ç”¨æˆ·ç‚¹å‡»æŒ‰é’®
- [ ] æŒ‡ä»¤æ­£ç¡®å‘é€åˆ°ä¼šè¯

### æµ‹è¯• 2: ä¼šè¯ä¸Šä¸‹æ–‡
- [ ] `/keep session-a` é”å®šä¼šè¯
- [ ] åç»­æ¶ˆæ¯è‡ªåŠ¨å‘é€åˆ° session-a
- [ ] `/keep off` å–æ¶ˆé”å®š

### æµ‹è¯• 3: æ™ºèƒ½é€‰æ‹©
- [ ] ç”¨æˆ·å‘é€æ¶ˆæ¯ä½†æ²¡æŒ‡å®šä¼šè¯
- [ ] æ˜¾ç¤ºä¼šè¯é€‰æ‹©æŒ‰é’®
- [ ] ç‚¹å‡»æŒ‰é’®åæ¶ˆæ¯æ­£ç¡®å‘é€

### æµ‹è¯• 4: è¾¹ç•Œæƒ…å†µ
- [ ] åªæœ‰ä¸€ä¸ªä¼šè¯æ—¶è‡ªåŠ¨å‘é€
- [ ] æ²¡æœ‰ä¼šè¯æ—¶æç¤ºé”™è¯¯
- [ ] ä¼šè¯ä¸å­˜åœ¨æ—¶æç¤ºé”™è¯¯
- [ ] æŒ‰é’®è¿‡æœŸå¤„ç†

---

## ğŸ“Š å®ç°ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¿…é¡»ï¼‰
1. âœ… åŠ¨æ€æŒ‰é’®å·¥å…·
2. âœ… æŒ‰é’®å›è°ƒå¤„ç†
3. âœ… ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†

### P1 - ç”¨æˆ·ä½“éªŒï¼ˆé‡è¦ï¼‰
1. âœ… æ™ºèƒ½ä¼šè¯é€‰æ‹©
2. âœ… /keep å‘½ä»¤
3. âœ… æ”¹è¿› /to å‘½ä»¤

### P2 - ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
1. â³ æŒ‰é’®çŠ¶æ€ç®¡ç†ï¼ˆå·²ç‚¹å‡»/è¿‡æœŸï¼‰
2. â³ æ“ä½œå†å²è®°å½•
3. â³ æ‰¹é‡æ“ä½œæ”¯æŒ

---

## ğŸš€ å¼€å§‹å®æ–½

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹ï¼
